{% extends "users/index.html" %}
{% with a_class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" %}{% endwith %}
{% block content_block %}

    <div class="p-6 px-8 space-y-5">
        <div class="p-6 px-8">

            <button id="parser_dropdown_btn"
                    class="w-52 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center flex justify-center items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                    type="button">
                Choose a Parser
                <svg class="w-2.5 h-2.5 ms-3"
                     aria-hidden="true"
                     xmlns="http://www.w3.org/2000/svg"
                     fill="none"
                     viewBox="0 0 10 6">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4" />
                </svg>
            </button>
            <!-- Dropdown menu -->
            <div id="parser_dropdown_list" class="hidden w-52 absolute dark:bg-gray-800 border border-gray-700 rounded-xl shadow-l ">
                <input type="text" id="search" 
                
                class="w-52 bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-t-lg focus:ring-primary-600 
                focus:border-primary-600 block p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white 
                dark:focus:ring-blue-500 dark:focus:border-blue-500" 
    
                placeholder="Search...">
                <ul class="py-2 text-sm text-gray-700 dark:text-gray-200">
                    {% for parser_name in parsers %}
                        <li>
                            <a href="{% url "start" parser_name %}"
                               class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">{{ parser_name }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        <button id="dest_dropdown_btn"
                class="w-52 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center flex justify-center items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                type="button">
            Choose a target
            <svg class="w-2.5 h-2.5 ms-3"
                 aria-hidden="true"
                 xmlns="http://www.w3.org/2000/svg"
                 fill="none"
                 viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4" />
            </svg>
        </button>
        <!-- Dropdown menu -->
        <div id="dest_dropdown_list"
             class="hidden w-52 absolute dark:bg-gray-800 border border-gray-700 rounded-xl shadow-l ">
            <ul class="py-2 text-sm text-gray-700 dark:text-gray-200">
                {% for dest_name in destinations %}
                    <li>
                        <a href="{% url "export" destination=dest_name %}"
                           class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">{{ dest_name }}</a>
                    </li>
                {% endfor %}
            </ul>
        </div>
        <div id="export_settings" class="w-[300px]">
            <form class="text-white w-[300px space-y-2" id="shop_auth">
                {% csrf_token %}
                {{ form.user }}
                <div class="flex" id="domain">
                    <span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border rounded-e-0 border-gray-300 border-e-0 rounded-s-md dark:bg-gray-600 dark:text-gray-400 dark:border-gray-600">
                        https://
                    </span>
                    {{ form.domain }}
                </div>

                <div class="flex" id="username">
                    <span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border rounded-e-0 border-gray-300 border-e-0 rounded-s-md dark:bg-gray-600 dark:text-gray-400 dark:border-gray-600">
                        <i class="fa-solid fa-user"></i>
                    </span>
                    {{ form.username }}
                </div>
         
                <div class="flex" id="password">
                    <span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border rounded-e-0 border-gray-300 border-e-0 rounded-s-md dark:bg-gray-600 dark:text-gray-400 dark:border-gray-600">
                        <i class="fa-solid fa-key"></i>
                    </span>
                    {% comment %} {{ form.password }} {% endcomment %}
                    <input type="password" name="password" maxlength="255" placeholder="Password" class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm focus:ring-primary-600 
focus:border-primary-600 block p-1 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white 
dark:focus:ring-blue-500 dark:focus:border-blue-500 w-full" id="id_password">
                    <span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border rounded-e-lg border-gray-300 cursor-pointer dark:bg-gray-600 dark:text-gray-400 dark:border-gray-600" onclick="togglePassword()">
                        <i class="fa-solid fa-eye" id="togglePasswordIcon"></i>
                    </span>
                </div>
                <button id="connect"
                        type="submit"
                        class="text-white font-bold bg-gradient-to-r from-green-400 via-green-500 to-green-600 hover:bg-gradient-to-br focus:ring-4 focus:outline-none focus:ring-green-300 dark:focus:ring-green-800 shadow-lg shadow-green-500/50 dark:shadow-lg dark:shadow-green-800/80 rounded-lg text-sm px-5 py-2.5 text-center w-full">
                    <div class="flex justify-center align-middle space-x-2">
                        <div class="flex align-middle" id="button_icon">
                            <i class="inline-flex self-center fa-solid fa-plug" id="plug"></i>
                            <div id="spinner" class="hidden">
                                {% include "users/elements/spinner_element.html" %}
                            </div>
                            <div id="checked" class="hidden">
                                {% include "users/elements/check_element.html" %}
                            </div>
                        </div>
                        <span id="connect_button_label">Connect</span>
                    </div>
                </button>
            </form>
        </div>
    </div>
    <script>
        document.getElementById('dest_dropdown_btn').addEventListener('click', function () {
            let dropdown = document.getElementById('dest_dropdown_list');
            dropdown.classList.toggle('hidden');
        });

        window.onclick = function(event) {
            if (!event.target.matches('#dest_dropdown_btn') && !event.target.matches('#search')) {
                var dropdowns = document.getElementsByClassName("dropdown-menu");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (!openDropdown.classList.contains('hidden')) {
                        openDropdown.classList.add('hidden');
                    }
                }
            }
        }
    </script>
    <script> 
        document
        .getElementById("shop_auth")
        .addEventListener("submit", async function (event) {
            event.preventDefault();
            
            document.getElementById("plug").classList.add("hidden");
            document.getElementById("plug").classList.add("hidden");
            document.getElementById("spinner").classList.remove("hidden");
            document.getElementById("spinner").classList.add("flex");
            document.getElementById("connect").classList.remove("from-green-400", "via-green-500", "to-green-600");
            document.getElementById("connect_button_label").innerHTML = "Connecting...";

            var formData = new FormData(this);
            var classToAddOnSuccess = [
                "border", 
                "border-2", 
                "dark:border-green-500", 
                "rounded-lg",
            ]
            var classToAddOnFailure = [
                "border", 
                "border-2", 
                "dark:border-red-500", 
                "rounded-lg",
            ]

            fetch("{% url 'check_shop_connection' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                  },
                body: formData,
            })
            .then((response) => {
                if (response.ok) {
                    return response.text();
                } else {
                    throw new Error("An error occurred. Please try again.");
                }
            })
            .then((data) => {
                document.getElementById("domain").classList.add(...classToAddOnSuccess);
                document.getElementById("username").classList.add(...classToAddOnSuccess);
                document.getElementById("password").classList.add(...classToAddOnSuccess);
                document.getElementById("spinner").classList.remove("flex");
                document.getElementById("spinner").classList.add("hidden");
                document.getElementById("checked").classList.remove("hidden");
                document.getElementById("checked").classList.add("flex");         
                document.getElementById("connect_button_label").innerHTML = "Connected!";
       
            })
        })
    </script>
    <script>
        function togglePassword() {
            const passwordField = document.querySelector('#password input');
            const passwordIcon = document.getElementById('togglePasswordIcon');
            const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);
            passwordIcon.classList.toggle('fa-eye');
            passwordIcon.classList.toggle('fa-eye-slash');
        }
    </script>
{% endblock content_block %}
